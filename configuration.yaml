
# Configure a default setup of Home Assistant (frontend, api, etc)
default_config:

homeassistant:
  name: Home
  latitude: !secret lat
  longitude: !secret long
  elevation: 140
  unit_system: metric
  time_zone: Europe/Minsk
  external_url: !secret white_host
  internal_url: http://192.168.1.2:8123
  customize: !include customize.yaml
  packages: !include_dir_merge_named packages

# Text to speech
#tts:
#  - platform: google_translate

recorder:
  auto_purge: true
  purge_keep_days: 1
  commit_interval: 30
  include:
    domains:
      - light
      - switch
    entity_globs:
      - sensor.*_hum
      - sensor.*_humidity
      - sensor.*_humidity_floating
      - sensor.*_temp
      - sensor.*_temperature
      - sensor.*_temperature_floating
      - sensor.*_pressure_mmhg
      - sensor.*_co2
      - sensor.*_co2_floating
      - sensor.*_power
      - sensor.*_action
    entities:
      # Person
      - person.sergey
      - person.alexa
      # Motion
      - binary_sensor.entrance_motion_sensor_occupancy
      - binary_sensor.rf_motion_0
      - binary_sensor.rf_motion_1
      - binary_sensor.kitchen_motion
      # Water leak
      - binary_sensor.kitchen_water_leak
      # Smoke detection
      - binary_sensor.rf_smoke_0
      - binary_sensor.honeywell_smoke_sensor
      # Reed switch
      - binary_sensor.door_window_sensor_158d0001fa3431
      # Illumination
      - sensor.illumination_7811dcb2404d
      # Radiator
      - sensor.moes_radiator_actuator_1_position
      - sensor.moes_radiator_actuator_2_position
      - sensor.moes_radiator_actuator_3_position
      # Humidifier
      - fan.humidifier_1
      - sensor.humidifier_1_water
      - sensor.humidifier_1_depth
      - fan.humidifier_2
      - sensor.humidifier_2_water
      - sensor.humidifier_2_depth
      # Filter drink
      - sensor.kitchen_filter_drink_pulses
      - sensor.kitchen_filter_drink_sum
      - binary_sensor.kitchen_filter_drink_flows
      - sensor.kitchen_filter_drink_daily
      # Filter raw
      - sensor.kitchen_filter_raw_pulses
      - sensor.kitchen_filter_raw_sum
      - binary_sensor.kitchen_filter_raw_flows
      - sensor.kitchen_filter_raw_daily
      # Temporary
      - binary_sensor.bedroom_mirror_switch_contact
      - automation.toggle_bedroom_mirror_with_switch
      - sensor.cabinet_desk_lamp_color_temp
      - sensor.cabinet_desk_lamp_adaptive_color_temp
      - sensor.xiaomi_thp_1_pressure
      - sensor.xiaomi_thp_2_pressure

lovelace:
  mode: yaml
  resources:
    - url: /local/vertical-stack-in-card.js?v=0.3.2
      type: js
  dashboards:
    lovelace-environment:
      mode: yaml
      filename: lovelace/environment.yaml
      title: Environment
      icon: mdi:chart-areaspline
      show_in_sidebar: true
      require_admin: false

group: !include groups.yaml
automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

mqtt:
  broker: core-mosquitto  # Локальный брокер
  #broker: IP adress  # Внешний брокер
  discovery: true
  discovery_prefix: homeassistant  
  username: mqtt
  password: mqtt

yeelight:
  devices:
    192.168.1.226:
      name: Kitchen Ceiling
      save_on_change: true
      nightlight_switch_type: light
      model: ceiling3
    192.168.1.182:
      name: Cabinet Desk Lamp
      save_on_change: true
      model: lamp1

light:
  - platform: xiaomi_miio
    host: 192.168.1.44
    token: !secret xiaomi_bulb1_token
    model: philips.light.bulb
  - platform: mqtt
    name: "ShellyDimmerWN0"
    command_topic: "ShellyDimmerWN0/cmnd/POWER"
    state_topic: "ShellyDimmerWN0/tele/STATE"
    state_value_template: "{{ value_json.POWER }}"
    availability_topic: "ShellyDimmerWN0/tele/LWT"
    brightness_command_topic: "ShellyDimmerWN0/cmnd/Dimmer"
    brightness_state_topic: "ShellyDimmerWN0/tele/STATE"
    brightness_scale: 100
    on_command_type: "brightness"
    brightness_value_template: "{{ value_json.Dimmer }}"
    payload_on: "ON"
    payload_off: "OFF"
    payload_available: "Online"
    payload_not_available: "Offline"
    qos: 1
    retain: false
  - platform: switch
    name: Kitchen 2 Relay L1
    entity_id: switch.kitchen_2_relay_l1
  - platform: switch
    name: Kitchen 2 Relay L2
    entity_id: switch.kitchen_2_relay_l2
  - platform: switch
    name: Entrance Wall Switch Right
    entity_id: switch.entrance_wall_switch_right
  - platform: switch
    name: Entrance Wall Switch Left
    entity_id: switch.entrance_wall_switch_left
  - platform: switch
    name: Cabinet Wall Switch Left
    entity_id: switch.cabinet_wall_switch_left
  - platform: switch
    name: Cupboard Relay
    entity_id: switch.cupboard_relay
  - platform: switch
    name: Hall Wall Switch Left
    entity_id: switch.hall_wall_switch_left
  - platform: switch
    name: Hall Wall Switch Right
    entity_id: switch.hall_wall_switch_right
  - platform: switch
    name: Bedroom Wall Switch Left
    entity_id: switch.bedroom_wall_switch_left
  - platform: switch
    name: Bedroom Bed
    entity_id: switch.xiaomi_power_plug_1_switch
  - platform: switch
    name: Bedroom Mirror
    entity_id: switch.xiaomi_socket_1

adaptive_lighting:
  - name: "Cabinet Desk Lamp"
    lights: 
      - light.cabinet_desk_lamp
    transition: 60
    initial_transition: 0
    interval: 300
    min_brightness: 1
    max_brightness: 65
    min_color_temp: 2710
    max_color_temp: 4950
    sleep_brightness: 1
    sleep_color_temp: 2710
    detect_non_ha_changes: true

binary_sensor:
  - platform: tod
    name: tod_night
    after: '00:00'
    before: '07:00'
  - platform: tod
    name: tod_day
    after: '07:00'
    before: '00:00'

telegram_bot:
  - platform: webhooks
    api_key: !secret telegram_home_key
    allowed_chat_ids:
      - !secret telegram_chat_sergey
      - !secret telegram_chat_alexa
      - !secret telegram_chat_log
    trusted_networks:
      - 172.30.33.2/32
      - 172.30.33.3/32
      - 149.154.160.0/20
      - 91.108.4.0/22
      - 149.154.160.0/20
      - 91.108.4.0/22

camera:
  - platform: ffmpeg
    name: Sonoff-Camera-1
    input: -rtsp_transport tcp -i rtsp://rtsp:sonoff@192.168.1.93:554/av_stream/ch0

switch:
  - platform: broadlink
    host: 192.168.1.69
    mac: 'C8:F7:42:62:FB:3B'

sensor:
  - platform: template
    sensors:
      radiator_1_temp:
        unique_id: radiator_1_current_temperature
        friendly_name: "Radiator Actuator #1 Current Temperature"
        unit_of_measurement: '°C'
        value_template: "{{ state_attr('climate.moes_radiator_actuator_1_climate', 'current_temperature') }}"
        availability_template: "{{ not is_state('climate.moes_radiator_actuator_1_climate', 'unavailable') }}"
      radiator_2_temp:
        unique_id: radiator_2_current_temperature
        friendly_name: "Radiator Actuator #2 Current Temperature"
        unit_of_measurement: '°C'
        value_template: "{{ state_attr('climate.moes_radiator_actuator_2_climate', 'current_temperature') }}"
        availability_template: "{{ not is_state('climate.moes_radiator_actuator_2_climate', 'unavailable') }}"
      radiator_3_temp:
        unique_id: radiator_3_current_temperature
        friendly_name: "Radiator Actuator #3 Current Temperature"
        unit_of_measurement: '°C'
        value_template: "{{ state_attr('climate.moes_radiator_actuator_3_climate', 'current_temperature') }}"
        availability_template: "{{ not is_state('climate.moes_radiator_actuator_3_climate', 'unavailable') }}"
      cabinet_desk_lamp_color_temp:
        unique_id: cabinet_desk_lamp_color_temp
        friendly_name: "Cabinet Desk Lamp Color Temp"
        unit_of_measurement: '°'
        value_template: "{{ state_attr('light.cabinet_desk_lamp', 'color_temp') }}"
        availability_template: "{{ not is_state('light.cabinet_desk_lamp', 'unavailable') }}"
      cabinet_desk_lamp_adaptive_color_temp:
        unique_id: cabinet_desk_lamp_adaptive_color_temp
        friendly_name: "Cabinet Desk Lamp [adaptive] Color Temp"
        unit_of_measurement: '°'
        value_template: "{{ state_attr('switch.adaptive_lighting_cabinet_desk_lamp', 'color_temp_mired') }}"
        availability_template: "{{ not is_state('switch.adaptive_lighting_cabinet_desk_lamp', 'unavailable') }}"
      xiaomi_thp_1_pressure_mmhg:
        unique_id: xiaomi_thp_1_pressure_mmhg
        friendly_name: "Xiaomi THP #1 Pressure mmHg"
        unit_of_measurement: 'mmHg'
        value_template: "{{ (states('sensor.xiaomi_thp_1_pressure') | int * 0.75006156) | int }}"
        availability_template: "{{ not is_state('sensor.xiaomi_thp_1_pressure', 'unavailable') }}"
        icon_template: >-
          {% set state = states('sensor.xiaomi_thp_1_pressure_mmhg') | int %}
          {% if state > 820 %}
            mdi:gauge-full
          {% elif state > 760 %}
            mdi:gauge
          {% elif state > 700 %}
            mdi:gauge-low
          {% else %}
            mdi:gauge-empty
          {% endif %}
      xiaomi_thp_2_pressure_mmhg:
        unique_id: xiaomi_thp_2_pressure_mmhg
        friendly_name: "Xiaomi THP #2 Pressure mmHg"
        unit_of_measurement: 'mmHg'
        value_template: "{{ (states('sensor.xiaomi_thp_2_pressure') | int * 0.75006156) | int }}"
        availability_template: "{{ not is_state('sensor.xiaomi_thp_2_pressure', 'unavailable') }}"
        icon_template: >-
          {% set state = states('sensor.xiaomi_thp_2_pressure_mmhg') | int %}
          {% if state > 820 %}
            mdi:gauge-full
          {% elif state > 760 %}
            mdi:gauge
          {% elif state > 700 %}
            mdi:gauge-low
          {% else %}
            mdi:gauge-empty
          {% endif %}
  - platform: average
    name: 'Hall Average Temperature'
    precision: 1
    duration:
      minutes: 5
    entities:
      - sensor.xiaomi_mijia_d107_temperature
      - sensor.humidifier_1_temp
      - sensor.xiaomi_thp_1_temperature
  - platform: average
    name: 'Hall Average Humidity'
    precision: 1
    duration:
      minutes: 5
    entities:
      - sensor.xiaomi_mijia_d107_humidity
      - sensor.humidifier_1_hum
      - sensor.xiaomi_thp_1_humidity
  - platform: average
    name: 'Bedroom Average Temperature'
    precision: 1
    duration:
      minutes: 5
    entities:
      - sensor.bedroom_temp_and_hum_temperature
      - sensor.humidifier_2_temp
  - platform: average
    name: 'Bedroom Average Humidity'
    precision: 1
    duration:
      minutes: 5
    entities:
      - sensor.bedroom_temp_and_hum_humidity
      - sensor.humidifier_2_hum

webostv:
  - host: 192.168.1.130
    name: TV
    turn_on_action:
      service: remote.send_command
      data:
        entity_id: remote.broadlink_ir_bridge_remote
        command: !secret ir_tv_power
    customize:
      sources:
        - HDMI1
        - HDMI2
        - HDMI3
        - HDMI4
        - LiveTV
        - MEGOGO TV & Movies
        - Netflix
        - Tvigle
        - YouTube
        - ivi
        - Kinopoisk HD

media_player:
  - platform: webostv
    host:  192.168.1.130
    name: TV

yandex_station:
  username: !secret ya_username
  password: !secret ya_password
yandex_smart_home_fix:
yandex_smart_home:
  filter:
    include_domains:
    include_entities:
      - switch.cupboard_relay
      - switch.hall_wall_switch_left
      - switch.hall_wall_switch_right
      - light.shellydimmerwn0
      - switch.bedroom_wall_switch_left
      - switch.xiaomi_power_plug_1_switch
      - switch.xiaomi_socket_1
      - switch.entrance_wall_switch_right
      - switch.entrance_wall_switch_left
      - light.xiaomi_philips_light
      - light.wled_maria_bed
      - light.wled_tree
      - light.kitchen_ceiling
      - light.kitchen_ceiling_nightlight
      - switch.kitchen_2_relay_l1
      - switch.kitchen_2_relay_l2
      - switch.cabinet_wall_switch_left
      - light.cabinet_desk_lamp
      - light.xiaomi_gateway_light
      - media_player.tv
      - sensor.bedroom_average_temperature
      - sensor.hall_average_temperature
      - sensor.xiaomi_mijia_cb15_temperature
      - sensor.xiaomi_thp_2_temperature
      - fan.humidifier_1
      - fan.humidifier_2
      - script.good_night
      - script.at_bedroom
      - script.at_hall
      - script.at_cabinet
      - script.at_kitchen
      - group.hall_lights
      - group.hall_ceiling_lights
      - group.hall_bra_lights
      - group.bedroom_lights
      - group.cabinet_lights
      - group.entrance_lights
      - group.kitchen_lights
  entity_config:
    switch.cupboard_relay:
      type: devices.types.light
      name: 'Шкаф'
      room: 'Кабинет'
    switch.hall_wall_switch_left:
      type: devices.types.light
      name: 'Люстра 2'
      room: 'Зал'
    switch.hall_wall_switch_right:
      type: devices.types.light
      name: 'Люстра 3'
      room: 'Зал'
    light.shellydimmerwn0:
      type: devices.types.light
      name: 'Бра 2'
      room: 'Зал'
    switch.bedroom_wall_switch_left:
      type: devices.types.light
      name: 'Свет'
      room: 'Спальня'
    switch.xiaomi_power_plug_1_switch:
      type: devices.types.light
      name: 'Кровать'
      room: 'Спальня'
    switch.xiaomi_socket_1:
      type: devices.types.light
      name: 'Зеркало'
      room: 'Спальня'
    switch.entrance_wall_switch_right:
      type: devices.types.light
      name: 'Свет'
      room: 'Прихожая'
    switch.entrance_wall_switch_left:
      type: devices.types.light
      name: 'Свет'
      room: 'Коридор'
    light.xiaomi_philips_light:
      type: devices.types.light
      name: 'Бра 1'
      room: 'Зал'
    light.wled_maria_bed:
      type: devices.types.light
      name: 'Ночник'
      room: 'Спальня'
    light.wled_tree:
      type: devices.types.light
      name: 'Ёлка'
      room: 'Зал'
    light.kitchen_ceiling:
      type: devices.types.light
      name: 'Свет'
      room: 'Кухня'
    light.kitchen_ceiling_nightlight:
      type: devices.types.light
      name: 'Луна'
      room: 'Кухня'
    switch.kitchen_2_relay_l1:
      type: devices.types.light
      name: 'Гирлянда'
      room: 'Кухня'
    switch.kitchen_2_relay_l2:
      type: devices.types.light
      name: 'Подсветка'
      room: 'Кухня'
    switch.cabinet_wall_switch_left:
      type: devices.types.light
      name: 'Свет'
      room: 'Кабинет'
    light.cabinet_desk_lamp:
      type: devices.types.light
      name: 'Настольная лампа'
      room: 'Кабинет'
    light.xiaomi_gateway_light:
      type: devices.types.light
      name: 'Шайба'
      room: 'Прихожая'
    media_player.tv:
      type: devices.types.media_device.tv
      name: 'Телевизор'
      room: 'Зал'
    group.hall_lights:
      type: devices.types.light
      name: 'Всё'
      room: 'Зал'
    group.hall_ceiling_lights:
      type: devices.types.light
      name: 'Свет'
      room: 'Зал'
    group.hall_bra_lights:
      type: devices.types.light
      name: 'Бра'
      room: 'Зал'
    group.bedroom_lights:
      type: devices.types.light
      name: 'Всё'
      room: 'Спальня'
    group.cabinet_lights:
      type: devices.types.light
      name: 'Всё'
      room: 'Кабинет'
    group.entrance_lights:
      type: devices.types.light
      name: 'Всё'
      room: 'Прихожая'
    group.kitchen_lights:
      type: devices.types.light
      name: 'Всё'
      room: 'Кухня'
    sensor.bedroom_average_temperature:
      type: devices.types.sensor
      name: 'Воздух'
      room: 'Спальня'
      properties:
        - type: humidity
          entity: sensor.bedroom_average_humidity
        - type: co2_level
          entity: sensor.mh_z19_1_co2
    sensor.hall_average_temperature:
      type: devices.types.sensor
      name: 'Воздух'
      room: 'Зал'
      properties:
        - type: humidity
          entity: sensor.hall_average_humidity
    sensor.xiaomi_mijia_cb15_temperature:
      type: devices.types.sensor
      name: 'Воздух'
      room: 'Кухня'
      properties:
        - type: temperature
          entity: sensor.xiaomi_mijia_cb15_temperature
        - type: humidity
          entity: sensor.xiaomi_mijia_cb15_humidity
    fan.humidifier_1:
      type: devices.types.humidifier
      name: 'Увлажнитель'
      room: 'Зал'
      properties:
        - type: water_level
          entity: sensor.humidifier_1_water
    fan.humidifier_2:
      type: devices.types.humidifier
      name: 'Увлажнитель'
      room: 'Спальня'
      properties:
        - type: water_level
          entity: sensor.humidifier_2_water
    sensor.xiaomi_thp_2_temperature:
      type: devices.types.sensor
      name: 'Воздух'
      room: 'Балкон'
      properties:
        - type: humidity
          entity: sensor.xiaomi_thp_2_humidity
    # Скрипты
    script.good_night:
      name: 'Спокойной ночи'
      room: 'Скрипты'
    script.at_bedroom:
      name: 'Мы в спальне'
      room: 'Скрипты'
    script.at_hall:
      name: 'Мы в зале'
      room: 'Скрипты'
    script.at_cabinet:
      name: 'Мы в кабинете'
      room: 'Скрипты'
    script.at_kitchen:
      name: 'Мы на кухне'
      room: 'Скрипты'

notify:
  - name: sergey
    platform: telegram
    chat_id: !secret telegram_chat_sergey
  - name: alexa
    platform: telegram
    chat_id: !secret telegram_chat_alexa
  - name: log
    platform: telegram
    chat_id: !secret telegram_chat_log
  - name: family
    platform: group
    services:
      - service: sergey
      - service: alexa
  - name: tv
    platform: webostv
    host: 192.168.1.130