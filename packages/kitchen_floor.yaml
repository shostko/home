kitchen_floor:

  sensor:
    - name: "Kitchen Floor Temp"
      unique_id: kitchen_floor_temp
      platform: mqtt
      state_topic: "climate/lytko/10763110/state"
      value_template: "{{ value_json.temp }}"
      availability_topic: "climate/lytko/10763110/available"
      payload_available: "online"
      payload_not_available: "offline"
      device_class: "temperature"
      unit_of_measurement: "°C"
    - platform: template
      sensors:
        kitchen_floor_relay_fake:
          unique_id: kitchen_floor_relay_fake
          friendly_name: "Kitchen Floor Relay"
          unit_of_measurement: '°C'
          value_template: >-
            {% if is_state('binary_sensor.kitchen_floor_relay', 'on') %}
              28
            {% else %}
              16
            {% endif %}
          availability_template: "{{ not is_state('binary_sensor.kitchen_floor_relay', 'unavailable') }}"
        kitchen_floor_target_temp:
          unique_id: kitchen_floor_target_temp
          friendly_name: "Kitchen Floor Target"
          unit_of_measurement: '°C'
          value_template: "{{ state_attr('climate.lytko_kitchen', 'temperature') }}"
          availability_template: "{{ not is_state('climate.lytko_kitchen', 'unavailable') }}"
    - name: "Kitchen Floor ON Time"
      platform: history_stats
      entity_id: binary_sensor.kitchen_floor_relay
      state: 'on'
      type: time
      start: "{{ now().replace(hour=0, minute=0, second=0) }}"
      end: "{{ now() }}"

  rest_command:
    restart_lytko:
      url: "http://192.168.1.170/reset"

  binary_sensor:
    - name: "Kitchen Floor Relay"
      unique_id: kitchen_floor_relay
      platform: mqtt
      state_topic: "climate/lytko/10763110/state"
      value_template: "{{ value_json.relay }}"
      payload_on: "1"
      payload_off: "0"
      availability_topic: "climate/lytko/10763110/available"
      payload_available: "online"
      payload_not_available: "offline"
      device_class: "heat"
    - platform: tod
      name: kitchen_floor_off_night1
      after: '21:30'
      before: '00:00'
    - platform: tod
      name: kitchen_floor_off_night2
      after: '00:00'
      before: '07:00'
    - platform: tod
      name: kitchen_floor_on_morning
      after: '08:00'
      before: '9:30'
    - platform: tod
      name: kitchen_floor_on_day
      after: '12:30'
      before: '13:30'
    - platform: tod
      name: kitchen_floor_on_evening
      after: '17:30'
      before: '19:00'

  automation:
    
    - alias: "Kitchen floor: Restart"
      id: "Kitchen floor: Restart"
      trigger:
        # Термостат недоступен в течении 10 минут
        - platform: state
          entity_id: climate.lytko_kitchen
          to: 'unavailable'
          for:
            minutes: 10
      action:
        # Перезагрузить термостат
        - service: rest_command.restart_lytko
        # Дождаться загрузки термостата
        - delay: 5
        # - wait_for_trigger:
        #     - platform: state
        #       entity_id: climate.lytko_kitchen
        #       from: 'unavailable'
        #       # for: 10
        - wait_template: "{{ not is_state('climate.lytko_kitchen', 'unavailable') }}"
          timeout: "00:05:00"
        - choose:
            # timeout reached
            - conditions: "{{ not wait.completed }}"
              sequence:
                - service: notify.sergey
                  data:
                    title: "*Не удалось* перезагрузить термостат тёплого пола на кухне!"
          default:
            # Термостат перезагружен
            - delay: 10
            - service: notify.sergey
              data:
                title: "Термостат тёплого пола на кухне *перезагружен*!"
                message: "Целевая: _{{ state_attr('climate.lytko_kitchen', 'temperature') | float }}_°C"

    - alias: Kitchen floor adjust target
      id: Kitchen floor adjust target
      trigger:
        # Запущен HA
        - platform: homeassistant
          event: start
        # Перезагружены автоматизации
        - platform: event
          event_type: automation_reloaded
        # Ночь
        - platform: state
          entity_id: binary_sensor.kitchen_floor_off_night1
          from: 'on'
          to: 'off'
        - platform: state
          entity_id: binary_sensor.kitchen_floor_off_night1
          from: 'off'
          to: 'on'
        # Ночь
        - platform: state
          entity_id: binary_sensor.kitchen_floor_off_night2
          from: 'on'
          to: 'off'
        - platform: state
          entity_id: binary_sensor.kitchen_floor_off_night2
          from: 'off'
          to: 'on'
        # Завтрак
        - platform: state
          entity_id: binary_sensor.kitchen_floor_on_morning
          from: 'on'
          to: 'off'
        - platform: state
          entity_id: binary_sensor.kitchen_floor_on_morning
          from: 'off'
          to: 'on'
        # Обед
        - platform: state
          entity_id: binary_sensor.kitchen_floor_on_day
          from: 'on'
          to: 'off'
        - platform: state
          entity_id: binary_sensor.kitchen_floor_on_day
          from: 'off'
          to: 'on'
        # Ужин
        - platform: state
          entity_id: binary_sensor.kitchen_floor_on_evening
          from: 'on'
          to: 'off'
        - platform: state
          entity_id: binary_sensor.kitchen_floor_on_evening
          from: 'off'
          to: 'on'
        # Термостат стал доступен
        - platform: state
          entity_id: climate.lytko_kitchen
          from: 'unavailable'
      condition:
        # Термостат доступен
        - "{{ not is_state('climate.lytko_kitchen', 'unavailable') }}"
      action:
      - variables: 
          # Текущая установленная целевая температура
          current: "{{ state_attr('climate.lytko_kitchen', 'temperature') | float }}"
          # Необходимая целевая температура
          target: >-
            {% if
              is_state('binary_sensor.kitchen_floor_on_morning', 'on')
            or
              is_state('binary_sensor.kitchen_floor_on_day', 'on')
            or
              is_state('binary_sensor.kitchen_floor_on_evening', 'on')
            %}
              22
            {% elif 
              is_state('binary_sensor.kitchen_floor_off_night1', 'on') 
            or
              is_state('binary_sensor.kitchen_floor_off_night2', 'on') 
            %}
              20
            {% else %}
              21
            {% endif %}
      - choose:
        - conditions:
            # Текущая и требуемая целевые температуры отличаются
            - "{{ current != target }}"
          sequence:
            # Установить новую целевую температуру
            - service: climate.set_temperature
              target:
                entity_id: climate.lytko_kitchen
              data_template:
                temperature: "{{ target }}"
            # Отправить сообщение в log
            - service: notify.log
              data:
                title: "*Изменена температура тёплого пола на кухе*"
                message: |-
                  Тригер: {{ trigger.description | replace("_","\_") }}
                  Текущая: _{{ states('sensor.kitchen_floor_temp') | float }}_°C
                  Целевая: _{{ current }}_°C -> _{{ target }}_°C
