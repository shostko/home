humidifier:

  fan:
    - platform: xiaomi_miio
      host: 192.168.1.104
      model: zhimi.humidifier.ca1
      name: "Humidifier #1"
      token: !secret xiaomi_humidifier1_token
    - platform: xiaomi_miio
      host: 192.168.1.203
      model: zhimi.humidifier.ca1
      name: "Humidifier #2"
      token: !secret xiaomi_humidifier2_token

  sensor:
    - platform: template
      sensors:
        humidifier_1_temp:
          unique_id: humidifier_1_temp
          friendly_name: "Humidifier #1 Temperature"
          unit_of_measurement: '°C'
          value_template: "{{ state_attr('fan.humidifier_1', 'temperature') }}"
          availability_template: "{{ is_state('fan.humidifier_1', 'on') }}"
        humidifier_1_hum:
          unique_id: humidifier_1_hum
          friendly_name: "Humidifier #1 Humidity"
          unit_of_measurement: '%'
          value_template: "{{ state_attr('fan.humidifier_1', 'humidity') }}"
          availability_template: "{{ is_state('fan.humidifier_1', 'on') }}"
        humidifier_1_water:
          unique_id: humidifier_1_water
          friendly_name: "Humidifier #1 Water Level"
          unit_of_measurement: '%'
          value_template: >
            {% set depth = state_attr('fan.humidifier_1', 'depth') | int %}
            {%- if depth > 125 -%}
              detached
            {%- elif depth < 71 -%}
              0
            {%- else -%}
              {{ ((depth - 70) / 55 * 100) | int }}
            {% endif %}
          availability_template: "{{ not is_state('fan.humidifier_1', 'unavailable') }}"
          icon_template: >-
            {% if states('sensor.humidifier_1_water') | int > 30 %}
              mdi:waves
            {% else %}
              mdi:wave
            {% endif %}
        humidifier_2_temp:
          unique_id: humidifier_2_temp
          friendly_name: "Humidifier #2 Temperature"
          unit_of_measurement: '°C'
          value_template: "{{ state_attr('fan.humidifier_2', 'temperature') }}"
          availability_template: "{{ is_state('fan.humidifier_2', 'on') }}"
        humidifier_2_hum:
          unique_id: humidifier_2_hum
          friendly_name: "Humidifier #2 Humidity"
          unit_of_measurement: '%'
          value_template: "{{ state_attr('fan.humidifier_2', 'humidity') }}"
          availability_template: "{{ is_state('fan.humidifier_2', 'on') }}"
        humidifier_2_water:
          unique_id: humidifier_2_water
          friendly_name: "Humidifier #2 Water Level"
          unit_of_measurement: '%'
          value_template: >
            {% set depth = state_attr('fan.humidifier_2', 'depth') | int %}
            {%- if depth > 125 -%}
              detached
            {%- elif depth < 11 -%}
              0
            {%- else -%}
              {{ ((depth - 10) / 115 * 100) | int }}
            {% endif %}
          availability_template: "{{ not is_state('fan.humidifier_2', 'unavailable') }}"
          icon_template: >-
            {% if states('sensor.humidifier_2_water') | int > 30 %}
              mdi:waves
            {% else %}
              mdi:wave
            {% endif %}
    
  automation:
    
    - alias: Humidifier 1 is off
      trigger:
        # Увлажнитель выключен
        - platform: state
          entity_id: fan.humidifier_1
          to: 'off'
          for: "00:01:00"
      condition:
        - condition: numeric_state
          entity_id: sensor.humidifier_1_water
          above: 3
      action:
        # Сообщение
        - service: notify.sergey
          data_template:
            message: "Увлажнитель в зале выключен, хотя уровень воды {{ states('sensor.humidifier_1_water') }}%"
    
    - alias: Humidifier 1 no water
      trigger:
        # Воды почти нету
        - platform: numeric_state
          entity_id: sensor.humidifier_1_water
          below: 4
          for: "00:00:10"
      condition:
        - condition: state
          entity_id: sensor.humidifier_1
          state: 'on'
      action:
        # Выключить увлажнитель
        - service: fan.turn_off
          entity_id: fan.humidifier_1
        # Сообщение в LOG
        - service: notify.log
          data_template:
            message: "Увлажнитель в зале: no {{ trigger.from_state.state }} -> {{ trigger.to_state.state }}"
    
    - alias: Humidifier 1 water low
      trigger:
        # Уровень воды ниже порога (но вода есть)
        - platform: numeric_state
          entity_id: sensor.humidifier_1_water
          above: 3
          below: 30
          for: "00:00:10"
      condition:
        - condition: template
          value_template: "{{ trigger.from_state.state != 'unavailable' }}"
      action:
        # Установить режим low
        - service: fan.set_speed
          entity_id: fan.humidifier_1
          data:
            speed: silent
        # Сообщение в LOG
        - service: notify.log
          data_template:
            message: "Увлажнитель в зале: low {{ trigger.from_state.state }} -> {{ trigger.to_state.state }}"
    
    - alias: Humidifier 1 water enough
      trigger:
        # Уровень воды выше порога
        - platform: numeric_state
          entity_id: sensor.humidifier_1_water
          above: 30
          for: "00:00:10"
      condition:
        - condition: template
          value_template: >
            {{
              trigger.from_state.state != 'unavailable'
            and 
            (
              trigger.from_state.state == 'detached'
            or
              trigger.from_state.state | int < trigger.to_state.state | int
            )
            }}
      action:
        # Установить режим high
        - service: fan.set_speed
          entity_id: fan.humidifier_1
          data:
            speed: high
        # Сообщение в LOG
        - service: notify.log
          data_template:
            message: "Увлажнитель в зале: enough {{ trigger.from_state.state }} -> {{ trigger.to_state.state }}"
    
    - alias: Humidifier 2 is off
      trigger:
        # Увлажнитель выключен
        - platform: state
          entity_id: fan.humidifier_2
          to: 'off'
          for: "00:01:00"
      condition:
        - condition: numeric_state
          entity_id: sensor.humidifier_2_water
          above: 3
      action:
        # Сообщение
        - service: notify.sergey
          data_template:
            message: "Увлажнитель в спальне выключен, хотя уровень воды {{ states('sensor.humidifier_1_water') }}%"

    - alias: Humidifier 2 no water
      trigger:
        # Воды почти нету
        - platform: numeric_state
          entity_id: sensor.humidifier_2_water
          below: 4
          for: "00:00:10"
      condition:
        - condition: state
          entity_id: sensor.humidifier_2
          state: 'on'
      action:
        # Выключить увлажнитель
        - service: fan.turn_off
          entity_id: fan.humidifier_2
        # Сообщение в LOG
        - service: notify.log
          data_template:
            message: "Увлажнитель в спальне: no {{ trigger.from_state.state }} -> {{ trigger.to_state.state }}"
    
    - alias: Humidifier 2 water low
      trigger:
        # Уровень воды ниже порога (но вода есть)
        - platform: numeric_state
          entity_id: sensor.humidifier_2_water
          above: 3
          below: 30
          for: "00:00:10"
      condition:
        - condition: template
          value_template: "{{ trigger.from_state.state != 'unavailable' }}"
      action:
        # Установить режим low
        - service: fan.set_speed
          entity_id: fan.humidifier_2
          data:
            speed: silent
        # Сообщение в LOG
        - service: notify.log
          data_template:
            message: "Увлажнитель в спальне: low {{ trigger.from_state.state }} -> {{ trigger.to_state.state }}"
    
    - alias: Humidifier 2 water enough
      trigger:
        # Уровень воды выше порога
        - platform: numeric_state
          entity_id: sensor.humidifier_2_water
          above: 30
          for: "00:00:10"
      condition:
        - condition: template
          value_template: >
            {{
              trigger.from_state.state != 'unavailable'
            and 
            (
              trigger.from_state.state == 'detached'
            or
              trigger.from_state.state | int < trigger.to_state.state | int
            )
            }}
      action:
        # Установить режим high
        - service: fan.set_speed
          entity_id: fan.humidifier_2
          data:
            speed: high
        # Сообщение в LOG
        - service: notify.log
          data_template:
            message: "Увлажнитель в спальне: enough {{ trigger.from_state.state }} -> {{ trigger.to_state.state }}"
