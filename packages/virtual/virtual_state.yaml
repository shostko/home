virtual_state:

  input_select:

    home_presence:
      name: Home Presence
      options:
        - 'Away'
        - 'Noone'
        - 'Someone'
        - 'Everyone'
      icon: mdi:home-account

  automation:
    
    - alias: 'Home Presence update'
      id: 'Home Presence update'
      mode: queued
      trigger:
        # Запущен HA
        - platform: homeassistant
          event: start
        # Перезагружены автоматизации
        - platform: event
          event_type: automation_reloaded
        # Изменилось количество людей в зоне ДОМ
        - platform: state
          entity_id: zone.home
          for: '00:03:00'
        # Изменилось количество людей в зоне ГРОДНО
        - platform: state
          entity_id: zone.grodno
          for: '00:03:00'
        - platform: state
          entity_id: zone.b_rosy
          for: '00:03:00'
        - platform: state
          entity_id: zone.iuzhnyi
          for: '00:03:00'
        - platform: state
          entity_id: zone.lidskaja
          for: '00:03:00'
        - platform: state
          entity_id: zone.camp
          for: '00:03:00'
        - platform: state
          entity_id: zone.logoped
          for: '00:03:00'
      action:
        - service: input_select.select_option
          target:
            entity_id: input_select.home_presence
          data:
            option: >
              {%- if is_state('zone.home', '2') -%}
                Everyone
              {%- elif is_state('zone.home', '1') -%}
                Someone
              {%- elif
                is_state('zone.home', '0') 
                and
                is_state('zone.b_rosy', '0') 
                and
                is_state('zone.camp', '0') 
                and
                is_state('zone.iuzhnyi', '0') 
                and
                is_state('zone.grodno', '0') 
                and
                is_state('zone.lidskaja', '0') 
                and
                is_state('zone.logoped', '0') 
              -%}
                Away
              {%- else %}
                Noone
              {%- endif -%}
    
    - alias: 'Home Presence update: entrance door'
      id: 'Home Presence update: entrance door'
      mode: queued
      trigger:
        # Открылась дверь
        - platform: state
          entity_id: binary_sensor.entance_door_button
          to: 'on'
      condition:
        # Никого дома нету
        - condition: or
          conditions:
            - condition: state
              entity_id: input_select.home_presence
              state: Noone
            - condition: state
              entity_id: input_select.home_presence
              state: Away
      action:
        - service: input_select.select_option
          target:
            entity_id: input_select.home_presence
          data:
            option: Someone
    
    - alias: 'LOG: Home Presence updated'
      id: 'LOG: Home Presence updated'
      mode: queued
      trigger:
        - platform: state
          entity_id: input_select.home_presence
      action:
        # Отправить сообщение в log
        - service: notify.log
          data:
            message: "Home Presence updated: {{ states('input_select.home_presence') }}"
